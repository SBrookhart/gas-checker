
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Multichain Gas Checker (Key‑free)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg:#0b0f14; --card:#111827; --border:#1f2937; --text:#e5e7eb; --muted:#94a3b8;
    --cheap:#065f46; --moderate:#854d0e; --expensive:#7f1d1d; --accent:#243041;
  }
  body { background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; padding:20px; }
  h1 { text-align:center; margin-bottom:6px; }
  .meta { text-align:center; color:var(--muted); margin-bottom:10px; }
  .grid { display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
  .card { background:var(--card); padding:16px; border-radius:12px; border:1px solid var(--border); min-height:120px; display:flex; flex-direction:column; justify-content:space-between; }
  .card h2 { margin:0 0 8px; font-size:1.05rem; }
  .value { font-size:1.5rem; margin:6px 0; }
  .row { display:flex; justify-content:space-between; gap:10px; align-items:center; }
  .badge { display:inline-block; padding:4px 10px; border-radius:999px; font-size:.8rem; text-transform:capitalize; }
  .cheap{background:var(--cheap);} .moderate{background:var(--moderate);} .expensive{background:var(--expensive);}
  .err { color:#fca5a5; font-size:.9rem; }
  button { background:#1f2937; color:var(--text); border:1px solid var(--border); padding:6px 10px; border-radius:8px; cursor:pointer; }
  button:hover { background:var(--accent); }
  details.debug { max-width:980px; margin:16px auto; background:#0f1620; border:1px solid var(--border); border-radius:10px; padding:8px 12px; }
  .log { white-space:pre-wrap; font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px; color:#cbd5e1; max-height:200px; overflow:auto; background:#0b1119; border:1px solid #1f2937; border-radius:8px; padding:8px; }
  a.btn { color:#e5e7eb; text-decoration:none; background:#1f2937; border:1px solid #334155; padding:6px 10px; border-radius:8px; }
  a.btn:hover { background:#243041; }
</style>
</head>

<body>
  <h1>⛽ Multichain Gas Checker (Key‑free)</h1>
  <div class="meta">
    <span id="lastUpdated">Loading…</span>
    · Auto‑refresh every 45s
    · <button id="refreshBtn" title="Refresh now">Refresh</button>
  </div>

  <div id="root" class="grid"></div>

  <details class="debug">
    <summary>Debug (optional)</summary>
    <div class="log" id="debugLog">No logs yet.</div>
    <div style="margin-top:6px;color:#9ca3af;font-size:12px">
      ETH gas: Etherchain Gas Price Oracle (no key) · Fallback: Blockscout eth_gasPrice (no key).
      Polygon gas: Gas Station v2 (no key).
    </div>
  </details>

<script>
/** ========= Tiny debug logger ========= **/
const logEl = document.getElementById('debugLog');
function dlog(...args) {
  const line = args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' ');
  logEl.textContent += `\n${new Date().toLocaleTimeString()}  ${line}`;
  logEl.scrollTop = logEl.scrollHeight;
}

/** ========= Helpers ========= **/
function gasLevelFromGwei(g){ if(!isFinite(g)) return 'moderate'; if(g<=10) return 'cheap'; if(g<=30) return 'moderate'; return 'expensive'; }
function niceTime(ts=Date.now()){ return new Date(ts).toLocaleTimeString(); }
function lamportsToSol(l){ return l/1e9; }
function toGweiFromHexWei(weiHex){ try{ return parseInt(weiHex,16)/1e9; }catch{return NaN;} }

async function fetchWithTimeout(url, options={}, timeoutMs=6000){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const r = await fetch(url, { ...options, signal: ctrl.signal });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r;
  } finally { clearTimeout(id); }
}
async function rpcPOST(url, method, params=[], timeoutMs=6000){
  const body = JSON.stringify({ jsonrpc:"2.0", id:1, method, params });
  const r = await fetchWithTimeout(url, { method:'POST', headers:{'content-type':'application/json'}, body }, timeoutMs);
  const j = await r.json();
  if(j.error) throw new Error(j.error.message || 'RPC error');
  return j.result;
}

/** ========= Chain fetchers (no keys) ========= **/

// ETH — primary: Etherchain Gas Price Oracle; fallback: Blockscout eth_gasPrice
async function getEthereum(){
  // 1) Etherchain oracle (no key). Typical fields: safeLow, standard, fast, currentBaseFee, etc.
  try {
    dlog('ETH: trying Etherchain oracle');
    const r = await fetchWithTimeout('https://www.etherchain.org/api/gasPriceOracle', {}, 6000);
    const g = await r.json();
    // Prefer "standard" if present; otherwise pick any reasonable field.
    const propose = Number(g.standard ?? g.fast ?? g.safeLow ?? g.currentBaseFee);
    if (!isFinite(propose)) throw new Error('No usable field from Etherchain');
    dlog('ETH: Etherchain success', propose);
    return { chain:'Ethereum', unit:'gwei', value:propose, level:gasLevelFromGwei(propose), source:'Etherchain' };
  } catch (e) {
    dlog('ETH: Etherchain failed ->', e.message || e);
  }

  // 2) Blockscout ETH RPC fallback (no key): eth_gasPrice returns hex wei
  try {
    dlog('ETH: trying Blockscout eth_gasPrice');
    const gasPriceWeiHex = await rpcPOST('https://eth.blockscout.com/api/eth-rpc', 'eth_gasPrice', [], 6000);
    const propose = toGweiFromHexWei(gasPriceWeiHex);
    if (!isFinite(propose)) throw new Error('Invalid hex');
    dlog('ETH: Blockscout success', propose);
    return { chain:'Ethereum', unit:'gwei', value:propose, level:gasLevelFromGwei(propose), source:'Blockscout' };
  } catch (e) {
    dlog('ETH: Blockscout failed ->', e.message || e);
  }

  // 3) Graceful fallback card with helpful links
  return {
    chain:'Ethereum', unit:'gwei', value:NaN, level:'moderate',
    error:'ETH endpoints blocked by network/CORS right now',
    links: [
      { href:'https://www.etherchain.org/tools/gasPriceOracle', label:'Open Etherchain Gas Oracle' },
      { href:'https://etherscan.io/gastracker', label:'Open Etherscan Gas Tracker' }
    ]
  };
}

// Polygon — Gas Station v2 (no key)
async function getPolygon(){
  dlog('Polygon: gas station');
  const r = await fetchWithTimeout('https://gasstation.polygon.technology/v2', {}, 6000);
  const g = await r.json();
  const propose = g?.standard?.maxFee ?? g?.standard?.suggestedMaxFee ?? g?.fast?.maxFee ?? 0;
  return { chain:'Polygon', unit:'gwei', value:propose, level:gasLevelFromGwei(propose) };
}

// Arbitrum
async function getArbitrum(){
  const gasPriceWeiHex = await rpcPOST('https://arb1.arbitrum.io/rpc','eth_gasPrice',[],6000);
  const propose = toGweiFromHexWei(gasPriceWeiHex);
  return { chain:'Arbitrum', unit:'gwei', value:propose, level:gasLevelFromGwei(propose) };
}

// Optimism
async function getOptimism(){
  const gasPriceWeiHex = await rpcPOST('https://mainnet.optimism.io','eth_gasPrice',[],6000);
  const propose = toGweiFromHexWei(gasPriceWeiHex);
  return { chain:'Optimism', unit:'gwei', value:propose, level:gasLevelFromGwei(propose) };
}

// Base
async function getBase(){
  const gasPriceWeiHex = await rpcPOST('https://mainnet.base.org','eth_gasPrice',[],6000);
  const propose = toGweiFromHexWei(gasPriceWeiHex);
  return { chain:'Base', unit:'gwei', value:propose, level:gasLevelFromGwei(propose) };
}

// Avalanche
async function getAvalanche(){
  const gasPriceWeiHex = await rpcPOST('https://api.avax.network/ext/bc/C/rpc','eth_gasPrice',[],6000);
  const propose = toGweiFromHexWei(gasPriceWeiHex);
  return { chain:'Avalanche', unit:'gwei', value:propose, level:gasLevelFromGwei(propose) };
}

// Solana
async function getSolana(){
  try{
    let lamportsPerSig = 5000;
    try {
      const fees = await rpcPOST('https://api.mainnet-beta.solana.com','getRecentPrioritizationFees',[],5000);
      const arr = Array.isArray(fees) ? fees : [];
      const priors = arr.map(x=>x?.prioritizationFee).filter(n=>typeof n==='number' && n>=0);
      const median = priors.length ? priors.sort((a,b)=>a-b)[Math.floor(priors.length/2)] : 0;
      lamportsPerSig += median;
    } catch {
      const feesObj = await rpcPOST('https://api.mainnet-beta.solana.com','getFees',[],5000);
      if (feesObj?.value?.feeCalculator?.lamportsPerSignature) {
        lamportsPerSig = feesObj.value.feeCalculator.lamportsPerSignature;
      }
    }
    const sol = lamportsToSol(lamportsPerSig);
    return { chain:'Solana', unit:'SOL/tx', value:sol, level:'cheap' };
  } catch {
    return { chain:'Solana', unit:'SOL/tx', value:0.000005, level:'cheap', note:'est' };
  }
}

/** ========= Rendering ========= **/
function renderCards(results){
  const root = document.getElementById('root');
  const html = results.map(r=>{
    if(!r) return '';
    if (r.error) {
      // Error card with helpful links (for ETH)
      const links = (r.links||[]).map(l=>`<a class="btn" href="${l.href}" target="_blank" rel="noopener">${l.label}</a>`).join(' ');
      return `
        <div class="card">
          <div class="row"><h2>${r.chain}</h2><span class="badge ${r.level}">${r.level}</span></div>
          <div class="value">—</div>
          <div class="err" style="margin-bottom:8px;">${r.error}</div>
          <div>${links || ''}</div>
          <div class="row" style="color:var(--muted); font-size:.9rem; margin-top:8px;">
            <span>Partial fallback shown</span><span>${niceTime()}</span>
          </div>
        </div>
      `;
    }
    const valueStr = r.unit === 'gwei'
      ? (isFinite(r.value) ? `${r.value.toFixed(1)} gwei${r.source?` · ${r.source}`:''}` : '—')
      : `~${r.value.toFixed(6)} ${r.unit}${r.note ? ' (est)' : ''}`;
    return `
      <div class="card">
        <div class="row"><h2>${r.chain}</h2><span class="badge ${r.level}">${r.level}</span></div>
        <div class="value">${valueStr}</div>
        <div class="row" style="color:var(--muted); font-size:.9rem">
          <span>Live estimate</span><span>${niceTime()}</span>
        </div>
      </div>
    `;
  }).join('');
  root.innerHTML = html;
}

async function loadAll(){
  const fetchers = [
    () => getEthereum().catch(e=>({ chain:'Ethereum', error:e.message })),
    () => getPolygon().catch(e=>({ chain:'Polygon', error:e.message })),
    () => getArbitrum().catch(e=>({ chain:'Arbitrum', error:e.message })),
    () => getOptimism().catch(e=>({ chain:'Optimism', error:e.message })),
    () => getBase().catch(e=>({ chain:'Base', error:e.message })),
    () => getAvalanche().catch(e=>({ chain:'Avalanche', error:e.message })),
    () => getSolana().catch(e=>({ chain:'Solana', error:e.message })),
  ];
  const results = await Promise.all(fetchers.map(fn=>fn()));
  renderCards(results);
  document.getElementById('lastUpdated').textContent = `Last updated: ${niceTime()}`;
}

// init + auto-refresh
loadAll();
const REFRESH_MS = 45_000;
setInterval(loadAll, REFRESH_MS);
document.getElementById('refreshBtn').addEventListener('click', loadAll);
</script>
</body>
</html>
